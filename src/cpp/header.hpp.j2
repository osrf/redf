/* This file is generated by redf */

{# ROS2 style uses header guards, but we are using pragma once to avoid having to generating non-conflicting defines -#}
#pragma once

{% for ros_type in ros_types -%}
#include <{{ ros_type | snake }}.hpp>
{% endfor %}
#include <rclcpp/qos.hpp>

#include <string>
{% if distro == "foxy" -%}
#include <stdexcept>
{%- endif %}

namespace {{namespace}} {

{% for ep in redf.endpoints -%}
{%- set class_name = ep.title | pascal -%}
{% if ep.type == "topic" -%}
/**
{%- for line in split_lines(input=ep.description) %}
 * {{line}}
{%- endfor %}
 */
class {{class_name}} {
public:
  using MessageType = {{ ep.message_type | replace(from="/", to="::") }};

  static inline std::string topic_name({% for part in varsub(str=ep.topic_name, vars_only=True) %}{% if part.var %}const std::string& {{part.var}}{% if not loop.last %},{% endif %}{% endif %}{% endfor %}) {
    const std::string topic = {% for part in varsub(str=ep.topic_name) %}{% if part.var %}{{part.var}}{% else %}"{{part.raw}}"{% endif %}{% if not loop.last %} + {% endif %}{% endfor %};
    return topic;
  }

  static inline rclcpp::QoS qos(size_t history_depth = 10) {
    {% if ep.qos is qos_default -%}
    return rclcpp::QoS{history_depth};
    {%- elif ep.qos is qos_preset -%}
    {%- if ep.qos == "clock" -%}
    {%- if distro == "foxy" -%}
    throw std::runtime_error{"Clock QoS is not supported on foxy"};
    {%- else -%}
    return rclcpp::ClockQoS{rclcpp::KeepLast{history_depth}};
    {%- endif -%}
    {%- elif ep.qos == "parameter_events" -%}
    return rclcpp::ParameterEventsQoS{rclcpp::KeepLast{history_depth}};
    {%- elif ep.qos == "parameters" -%}
    return rclcpp::ParametersQoS{rclcpp::KeepLast{history_depth}};
    {%- elif ep.qos == "rosout" -%}
    {%- if distro == "foxy" -%}
    throw std::runtime_error("Rosout QoS is not supported on foxy");
    {%- else -%}
    return rclcpp::RosoutQoS{rclcpp::KeepLast{history_depth}};
    {%- endif -%}
    {%- elif ep.qos == "sensor_data" -%}
    return rclcpp::SensorDataQoS{rclcpp::KeepLast{history_depth}};
    {%- elif ep.qos == "services" -%}
    return rclcpp::ServicesQoS{rclcpp::KeepLast{history_depth}};
    {%- elif ep.qos == "system_defaults" -%}
    return rclcpp::SystemDefaultsQoS{rclcpp::KeepLast{history_depth}};
    {%- endif -%}
    {%- else -%}
    rclcpp::QoS qos{history_depth};

    {%- if distro == "foxy" %}
    {%- if ep.qos.reliability %}
    qos.reliability(RMW_QOS_POLICY_RELIABILITY_{{ ep.qos.reliability | screaming_snake }});
    {%- else %}
    qos.reliability(RMW_QOS_POLICY_RELIABILITY_SYSTEM_DEFAULT);
    {%- endif %}
    {%- if ep.qos.durability %}
    qos.durability(RMW_QOS_POLICY_DURABILITY_{{ ep.qos.durability | screaming_snake }});
    {%- else %}
    qos.durability(RMW_QOS_POLICY_DURABILITY_SYSTEM_DEFAULT);
    {%- endif %}
    {%- if ep.qos.liveliness %}
    qos.liveliness(RMW_QOS_POLICY_LIVELINESS_{{ ep.qos.liveliness | screaming_snake }});
    {%- else %}
    qos.liveliness(RMW_QOS_POLICY_LIVELINESS_SYSTEM_DEFAULT);
    {%- endif %}
    {%- else %}
    {%- if ep.qos.reliability %}
    qos.reliability(rclcpp::ReliabilityPolicy::{{ ep.qos.reliability | pascal }});
    {%- else %}
    qos.reliability(rclcpp::ReliabilityPolicy::SystemDefault);
    {%- endif %}
    {%- if ep.qos.durability %}
    qos.durability(rclcpp::DurabilityPolicy::{{ ep.qos.durability | pascal }});
    {%- else %}
    qos.durability(rclcpp::DurabilityPolicy::SystemDefault);
    {%- endif %}
    {%- if ep.qos.liveliness %}
    qos.liveliness(rclcpp::LivelinessPolicy::{{ ep.qos.liveliness | pascal }});
    {%- else %}
    qos.liveliness(rclcpp::LivelinessPolicy::SystemDefault);
    {%- endif %}
    {%- endif -%}

    {%- if ep.qos.deadline %}
    qos.deadline(rclcpp::Duration{%- raw -%}{{%- endraw -%}{{ep.qos.deadline.secs}}, {{ep.qos.deadline.nanosecs}}{%- raw -%}}{%- endraw -%});
    {%- endif -%}
    {%- if ep.qos.lifespan %}
    qos.lifespan(rclcpp::Duration{%- raw -%}{{%- endraw -%}{{ep.qos.deadline.secs}}, {{ep.qos.deadline.nanosecs}}{%- raw -%}}{%- endraw -%});
    {%- endif -%}
    {%- if ep.qos.lease_duration %}
    qos.liveliness_lease_duration(rclcpp::Duration{%- raw -%}{{%- endraw -%}{{ep.qos.deadline.secs}}, {{ep.qos.deadline.nanosecs}}{%- raw -%}}{%- endraw -%});
    {%- endif -%}
    {%- if ep.qos.avoid_ros_namespace_conventions %}
    qos.avoid_ros_namespace_conventions(true);
    {%- else %}
    qos.avoid_ros_namespace_conventions(false);
    {%- endif %}
    return qos;
    {%- endif %}
  }
};

{% endif -%}
{% if ep.type == "service" -%}
class {{ep.title | pascal}} {
public:
  using ServiceType = {{ ep.service_type | replace(from="/", to="::") }};

  static inline std::string service_name({% for part in varsub(str=ep.service_name, vars_only=True) %}{% if part.var %}const std::string& {{part.var}}{% if not loop.last %},{% endif %}{% endif %}{% endfor %}) {
    const std::string name = {% for part in varsub(str=ep.service_name) %}{% if part.var %}{{part.var}}{% else %}"{{part.raw}}"{% endif %}{% if not loop.last %} + {% endif %}{% endfor %};
    return name;
  }
};

{% endif -%}

{% if ep.type == "action" -%}
class {{ep.title | pascal}} {
public:
  using ActionType = {{ ep.action_type | replace(from="/", to="::") }};

  static inline std::string action_name({% for part in varsub(str=ep.action_name, vars_only=True) %}{% if part.var %}const std::string& {{part.var}}{% if not loop.last %},{% endif %}{% endif %}{% endfor %}) {
    const std::string name = {% for part in varsub(str=ep.action_name) %}{% if part.var %}{{part.var}}{% else %}"{{part.raw}}"{% endif %}{% if not loop.last %} + {% endif %}{% endfor %};
    return name;
  }
};

{% endif -%}
{% endfor -%}
}
